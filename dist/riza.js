import{EventDispatcher as e,Rinn as t}from"rinn";import n from"base-64";var r="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:{};const s={Route:e.extend({routeRegex:null,value:null,params:null,args:null,s_args:null,active:!1,changed:!1,__ctor:function(e){this._super.EventDispatcher.__ctor(),this._compileRoute(this.value=e)},_compileRoute:function(e){for(this.params=[],e=e.replace(/\/\*\//g,"/.+/");;){var t=/:([!@A-Za-z0-9_-]+)/.exec(e);if(!t)break;e=e.replace(t[0],"([^/]+)"),this.params.push(t[1])}this.routeRegex="^"+e.replace(/##/g,"")},addHandler:function(e,t=!1,n=null){this.addEventListener((!0===t?"un":"")+"routed",e,n)},removeHandler:function(e,t=!1,n=null){this.removeEventListener((!0===t?"un":"")+"routed",e,n)},dispatch:function(e){var t=e.match(this.routeRegex);if(!t)return this.s_args=null,this.active&&this.dispatchEvent("unrouted",{route:this}),void(this.active=!1);for(var n={route:this},r="",s=0;s<this.params.length;s++)n[this.params[s]]=t[s+1],r+="_"+t[s+1];this.changed=r!=this.s_args,this.s_args=r,this.dispatchEvent("routed",this.args=n),this.active=!0}}),routes:{},sortedRoutes:[],ignoreHashChangeEvent:0,location:"",args:[],init:function(){this.alreadyAttached||(this.alreadyAttached=!0,"onhashchange"in globalThis&&(globalThis.onhashchange=this.onLocationChanged.bind(this)))},refresh:function(){this.onLocationChanged()},setRoute:function(e,t){var n=this.realLocation(e);n!=this.location&&(t&&this.ignoreHashChangeEvent++,globalThis.location.hash=n)},addRoute:function(e,t,n=null){return this.routes[e]||(this.routes[e]=new this.Route(e),this.sortedRoutes.push(e),this.sortedRoutes.sort(((e,t)=>this.routes[e].routeRegex.length-this.routes[t].routeRegex.length))),null!==n?(this.routes[e].addHandler(t,!1),this.routes[e].addHandler(n,!0)):this.routes[e].addHandler(t,!1),this.routes[e]},getRoute:function(e){return this.routes[e]||(this.routes[e]=new this.Route(e),this.sortedRoutes.push(e),this.sortedRoutes.sort(((e,t)=>this.routes[e].routeRegex.length-this.routes[t].routeRegex.length))),this.routes[e]},addRoutes:function(e){for(var t in e)this.routes[t]||(this.routes[t]=new this.Route(t),this.sortedRoutes.push(t)),this.routes[t].addHandler(e[t],!1);this.sortedRoutes.sort(((e,t)=>this.routes[e].routeRegex.length-this.routes[t].routeRegex.length))},removeRoute:function(e,t,n){this.routes[e]&&(void 0!==n?(this.routes[e].removeHandler(t,!1),this.routes[e].removeHandler(n,!0)):this.routes[e].removeHandler(t))},removeRoutes:function(e){for(var t in e)this.routes[t]&&this.routes[t].removeHandler(e[t])},realLocation:function(e,t){t||(t=this.location),t||(t=" ");for(var n,r=0,s=0,o=0,i="";-1!=r&&s<e.length&&o<t.length;)switch(r){case 0:if("*"==e.substr(s++,1)){r=1;break}if(e.substr(s-1,1)!=t.substr(o++,1)){i+=e.substr(s-1),r=-1;break}i+=t.substr(o-1,1);break;case 1:if("*"==e.substr(s,1)){r=3,s++;break}r=2;break;case 2:if(-1==(n=t.indexOf(e.substr(s,1),o))){i+=t.substr(o)+e.substr(s),r=-1;break}i+=t.substr(o,n-o),r=0,o=n;break;case 3:if(-1==(n=t.lastIndexOf(e.substr(s,1)))){i+=e.substr(s),r=-1;break}i+=t.substr(o,n-o),r=0,o=n}return-1!=r&&(i+=e.substr(s)),i.trim()},onLocationChanged:function(){var e=location.hash.substr(1),t=this.realLocation(e);if(e==t)if(this.location=e,this.args=this.location.split("/"),this.ignoreHashChangeEvent>0)this.ignoreHashChangeEvent--;else for(var n=0;n<this.sortedRoutes.length;n++)this.routes[this.sortedRoutes[n]].dispatch(this.location);else globalThis.location.replace("#"+t)},navigate:function(e,t=!1){e=this.realLocation(e),globalThis.location.hash!="#"+e?t?globalThis.location.replace("#"+e):globalThis.location.hash=e:this.refresh()}};s.init();var o=s;const i={REQUEST_PACKAGE_SUPPORTED:1,REQ64_SUPPORTED:2,JSON_RESPONSE_SUPPORTED:4,XML_RESPONSE_SUPPORTED:8,INCLUDE_CREDENTIALS:16,UNIQUE_STAMP:32,apiUrl:"/api",flags:63,useReq64:!1,retries:0,headers:{},_requestLevel:0,_requestPackage:0,_packageData:[],setEndPoint:function(e,t=null){return this.apiUrl=e,this.flags=t??this.flags,this},responseFilter:function(e,t){return!0},packageBegin:function(){this.flags&i.REQUEST_PACKAGE_SUPPORTED&&this._requestPackage++},packageEnd:function(e){this.flags&i.REQUEST_PACKAGE_SUPPORTED&&this._requestPackage&&(--this._requestPackage||this.packageSend(e))},packRequests:function(e,t=null){this.flags&i.REQUEST_PACKAGE_SUPPORTED&&(this.packageBegin(),e(),this.packageEnd(t))},packageSend:function(e){if(!(this.flags&i.REQUEST_PACKAGE_SUPPORTED))return;if(!this._packageData.length)return;let t=this._packageData;this._packageData=[];for(var r="",s=0;s<t.length;s++)r+="r"+s+","+n.encode(this.encodeParams(t[s][2]))+";";this._showProgress(),this.apiCall({rpkg:r},((n,r)=>{this._hideProgress();for(let e=0;e<t.length;e++)try{var s=n["r"+e];if(!s){null!=t[e][1]&&t[e][1](t[e][2]);continue}null!=t[e][0]&&this.responseFilter(s,t[e][2])&&t[e][0](s,t[e][2])}catch(e){}e&&e()}),(e=>{this._hideProgress();for(let e=0;e<t.length;e++)null!=t[e][1]&&t[e][1](t[e][2])}))},_showProgress:function(){"document"in r&&(this._requestLevel++,this._requestLevel>0&&r.document.documentElement.classList.add("busy"))},_hideProgress:function(){if("document"in r){if(this._requestLevel--,this._requestLevel)return;setTimeout((()=>{0===this._requestLevel&&r.document.documentElement.classList.remove("busy")}),250)}},header:function(e,t){return null===t?delete this.headers[e]:this.headers[e]=t,this},encodeParams:function(e){let t=[];if(e instanceof FormData)for(let n of e.entries())t.push(encodeURIComponent(n[0])+"="+encodeURIComponent(n[1]));else for(let n in e)t.push(encodeURIComponent(n)+"="+encodeURIComponent(e[n]));return t.join("&")},getUrl:function(e){return-1!==e.indexOf("//")?e:this.apiUrl+e},appendParam:function(e,t){return e+(-1==e.indexOf("?")?"?":"&")+t},apiCall:function(e,t,s,o=null,a=null,l=""){let u=this.getUrl(l);if(this.flags&i.UNIQUE_STAMP&&(u=this.appendParam(u,"_="+Date.now())),"GET"!=(o=o?o.toUpperCase():null)&&"POST"!=o&&(o="auto"),null===a&&(a=this.retries),this._requestPackage&&this.flags&i.REQUEST_PACKAGE_SUPPORTED)return e instanceof FormData||(e={...e}),void this._packageData.push([t,s,e]);this._showProgress();let h=e,c={mode:"cors",headers:{Accept:"text/html,application/xhtml+xml,application/xml,application/json;q=0.9",...this.headers},method:o,body:null,multipart:!1};if(this.flags&i.INCLUDE_CREDENTIALS&&(c.credentials="include"),"string"==typeof h||h instanceof Blob)"string"==typeof h?"<"===h[0]?h.endsWith("</soap:Envelope>")?c.headers["Content-Type"]="application/soap+xml":c.headers["Content-Type"]="application/xml":"{"===h[0]?c.headers["Content-Type"]="application/json":c.headers["Content-Type"]="application/octet-stream":c.headers["Content-Type"]=h.type,c.method="POST",c.body=h;else{if(!(h instanceof FormData)){h=new FormData;for(let t in e)e[t]instanceof File||e[t]instanceof Blob?h.append(t,e[t],e[t].name):h.append(t,e[t])}for(let e of h.entries())if(e[1]instanceof File||e[1]instanceof Blob){c.method="POST",c.multipart=!0;break}if(this.useReq64&&this.flags&i.REQ64_SUPPORTED&&!c.multipart){let e=new FormData;e.append("req64",n.encode(this.encodeParams(h))),h=e}if("auto"==c.method){let e=0;c.method="GET";for(let t of h.entries())if(e+=t[0].length+t[1].length+2,e>960){c.method="POST";break}}"GET"==c.method?u=this.appendParam(u,this.encodeParams(h)):c.multipart?c.body=h:(c.headers["Content-Type"]="application/x-www-form-urlencoded",c.body=this.encodeParams(h))}r.fetch(u,c).then((e=>this.decodeResult(e))).then((n=>{if(this._hideProgress(),t&&this.responseFilter(n,e))try{t(n,e)}catch(e){}})).catch((n=>{this._hideProgress(),0==a?s&&s(e):this.apiCall(h,t,s,o,a-1,l)}))},decodeResult:function(e){let t=e.headers.get("content-type").split(";")[0].toLowerCase();return this.flags&i.JSON_RESPONSE_SUPPORTED&&-1!==t.indexOf("json")?e.json():this.flags&i.XML_RESPONSE_SUPPORTED&&-1!==t.indexOf("xml")?new Promise(((t,n)=>{e.text().then((e=>{e=(new DOMParser).parseFromString(e,"text/xml"),t(e)})).catch(n)})):e.blob()},getBlob:function(e,t){return new Blob([e],{type:t})},base64:{encode:function(e){return n.encode(e)},decode:function(e){return n.decode(e)}},post:function(e,t=null,n=null){return this.apiCall(e,t,n,"POST")},get:function(e,t=null,n=null){return this.apiCall(e,t,n,"GET")},fetch:function(e,t=null){return null===t&&"string"!=typeof e&&(t=e,e=""),new Promise(((n,r)=>{this.apiCall(t,n,r,null,null,e)}))},makeUrl:function(e,t=null){return null===t&&"string"!=typeof e&&(t=e,e=""),this.appendParam(this.getUrl(e),this.encodeParams(t))}};var a=i;const l={showDownload:function(e,t){var n=document.createElement("a");n.href=t,n.style.display="none",n.download=e,n.target="_blank",document.body.appendChild(n),n.click(),document.body.removeChild(n)},showFilePicker:function(e,t,n){var r=document.createElement("input");r.type="file",r.accept=t,r.style.display="none",r.multiple=e,document.body.appendChild(r),r.onchange=function(){n(r.files)},document.body.onfocus=function(){document.body.onfocus=null,document.body.removeChild(r)},r.click()},loadAsDataUrl:function(e,t){var n=new FileReader;n.onload=function(e){t(e.target.result,null)},n.onerror=function(e){t(null,e)},n.readAsDataURL(e)},loadAsText:function(e,t){var n=new FileReader;n.onload=function(e){t(e.target.result)},n.readAsText(e)},loadAsArrayBuffer:function(e,t){var n=new FileReader;n.onload=function(e){t(e.target.result)},n.readAsArrayBuffer(e)},loadAllAsDataUrl:function(e,t){var n=[];if(e&&e.length){var r=function(s){s!=e.length?l.loadAsDataUrl(e[s],(function(t,o){o||n.push({name:e[s].name,size:e[s].size,url:t}),r(s+1)})):t(n)};r(0)}else t(n)},loadImageFromUrl:function(e,t){let n=new Image;n.onload=()=>t(n),n.onerror=()=>t(null),n.src=e}};var u=l,//!class db
h={db:null,init:function(e,t,n){return new Promise(((s,o)=>{if(!r.indexedDB)return void o("IndexedDB is not available in your system.");let i=indexedDB.open(e,t);i.onerror=e=>{let t=e.target.error+"";-1!==t.indexOf("AbortError")&&(t="\n"+i.message),o("Unable to open database: "+t)},i.onupgradeneeded=async e=>{try{const t=e.target.result,r=e.target.transaction;e.oldVersion<1&&t.createObjectStore("system",{keyPath:["name"]}),await n(t,r,e.oldVersion)}catch(e){i.message=e.message,i.transaction.abort()}},i.onsuccess=async e=>{this.db=e.target.result,s()}}))},ensureConnected:function(){this.db||alert("Error: Database not initialized.")},index:function(e,t){this.ensureConnected();let n=this.db.transaction(e,"readwrite").objectStore(e).index(t);if(!n)throw new Error("Unable to find index `"+t+"` in store "+e);return n},forEach:function(e,t,n){return this.ensureConnected(),"function"==typeof t&&(n=t,t=null),new Promise((async(r,s)=>{let o,i;i="string"==typeof e?this.db.transaction(e,"readwrite").objectStore(e):e,o=null===t?i.openCursor():i.openCursor(t),o.onsuccess=async e=>{let t=e.target.result;t&&!1!==await n(t.value,t)?t.continue():r()},o.onerror=e=>{s(e.target.error)}}))},count:function(e){return this.ensureConnected(),new Promise(((t,n)=>{let r;r="string"==typeof e?this.db.transaction(e,"readonly").objectStore(e):e;let s=r.count();s.onsuccess=e=>{t(e.target.result)},s.onerror=e=>{n(e.target.error)}}))},getAll:function(e,t=null){return this.ensureConnected(),new Promise(((n,r)=>{let s;s="string"==typeof e?this.db.transaction(e,"readonly").objectStore(e):e;let o=s.getAll(t);o.onsuccess=e=>{n(e.target.result)},o.onerror=e=>{r(e.target.error)}}))},getAllKeys:function(e,t=null){return this.ensureConnected(),new Promise(((n,r)=>{let s;s="string"==typeof e?this.db.transaction(e,"readonly").objectStore(e):e;let o=s.getAllKeys(t);o.onsuccess=e=>{n(e.target.result)},o.onerror=e=>{r(e.target.error)}}))},getAllUnique:function(e,t=null){return this.ensureConnected(),new Promise(((n,r)=>{let s;s="string"==typeof e?this.db.transaction(e,"readonly").objectStore(e):e;let o=s.openCursor(null,"nextunique"),i=[];o.onsuccess=e=>{let r=e.target.result;r?(i.push(t?r.value[t]:r.value),r.continue()):n(i)},o.onerror=e=>{r(e.target.error)}}))},get:function(e,t){return this.ensureConnected(),new Promise(((n,r)=>{let s;s="string"==typeof e?this.db.transaction(e,"readonly").objectStore(e):e;let o=s.get(t);o.onsuccess=e=>{n(e.target.result||null)},o.onerror=e=>{r(e.target.error)}}))},put:function(e,t){return this.ensureConnected(),new Promise(((n,r)=>{let s=this.db.transaction(e,"readwrite").objectStore(e).put(t);s.onsuccess=e=>{n()},s.onerror=e=>{r(e.target.error)}}))},sysGet:async function(e,t=!1){let n=await this.get("system",[e]);return n?t?n:n.value:null},sysPut:async function(e,t,n=!1){n?(t.name=e,await this.put("system",t)):await this.put("system",{name:e,value:t})},findOne:function(e,n=null,r=null){return this.ensureConnected(),new Promise(((s,o)=>{let i;i="string"==typeof e?this.db.transaction(e,"readonly").objectStore(e):e;let a=i.openCursor();a.onsuccess=e=>{let o=e.target.result;if(o)return null===n||t.partialCompare(o.value,n)?null!==r&&t.partialCompare(o.value,r)?void o.continue():void s(o.value):void o.continue();s(null)},a.onerror=e=>{o(e.target.error)}}))},delete:function(e,t){return this.ensureConnected(),new Promise(((n,r)=>{let s=this.db.transaction(e,"readwrite").objectStore(e).delete(t);s.onsuccess=e=>{n()},s.onerror=e=>{r(e.target.error)}}))},deleteAll:function(e,t=null){return this.forEach(e,t,(async(e,t)=>{await t.delete()}))},insert:function(e,t){return this.ensureConnected(),new Promise(((n,r)=>{let s=this.db.transaction(e,"readwrite").objectStore(e).add(t);s.onsuccess=e=>{n()},s.onerror=e=>{r(e.target.error)}}))}};function c(e){this.value=null,this.next=null,this.prev=null,this.list=null}function d(){this.head=null,this.tail=null,this.length=0}c.create=function(e){let t=new c;return t.value=e,t},c.prototype.free=function(){let e=this.value;return this.unlink(),this.next=this.prev=null,this.list=null,this.value=null,e},c.prototype.linkAfter=function(e,t){return this.next=null!==e?e.next:null,this.prev=e,this.list=t,null!==e&&(null!==e.next&&(e.next.prev=this),e.next=this),t.tail===e&&(t.tail=this),null===t.head&&(t.head=this),t.length++,this},c.prototype.linkBefore=function(e,t){return this.prev=null!==e?e.prev:null,this.next=e,this.list=t,null!==e&&(null!==e.prev&&(e.prev.next=this),e.prev=this),t.head===e&&(t.head=this),null===t.tail&&(t.tail=this),t.length++,this},c.prototype.unlink=function(){return this.prev&&(this.prev.next=this.next),this.next&&(this.next.prev=this.prev),this.list.head===this&&(this.list.head=this.next),this.list.tail===this&&(this.list.tail=this.prev),this.list.length--,this},d.create=function(){return new d},d.prototype.free=function(){this.clear()},d.prototype.reset=function(){for(;null!==this.head;)this.head.free();return this},d.prototype.clear=function(){for(;null!==this.head;)null!==this.head.value&&this.head.value.free(),this.head.free();return this},d.prototype.first=function(){return null!==this.head?this.head.value:null},d.prototype.last=function(){return null!==this.tail?this.tail.value:null},d.prototype.find=function(e){for(let t=this.head;null!==t;t=t.next)if(t.value===e)return t;return null},d.prototype.unshift=function(e){return c.create(e).linkBefore(this.head,this),e},d.prototype.shift=function(){return null===this.head?null:this.head.free()},d.prototype.push=function(e){return c.create(e).linkAfter(this.tail,this),e},d.prototype.pop=function(){return null===this.tail?null:this.tail.free()};let f=null,p=!1,g=d.create(),m=!1;function v(e){if(!0===e.isPropagating)return;e.isPropagating=!0;let t=e.watchers;for(e.watchers=d.create();t.length;)t.shift()();t.free(),e.isPropagating=!1}function b(){for(m=!1,p=!0;g.length;)v(g.shift());p=!1}function y(e=null){const t={watchers:d.create(),value:e,isPropagating:!1,wasQueued:!1};return t.accessor=(e,n=!1)=>function(e,t,n){return void 0===t?(null!==f&&null===e.watchers.find(f)&&e.watchers.push(f),e.value):e.value===t&&!1===n?e.accessor:(e.previousValue=e.value,e.value=t,!0===p?(e.isPropagating||!1===e.wasQueued&&(g.push(e),e.wasQueued=!0,!1===m&&(queueMicrotask(b),m=!0)),e.accessor):(p=!0,v(e),p=!1,e.accessor))}(t,e,n),t.accessor}function P(e,t=null){let n=null,r=!1;const s=function(){!0!==r&&(r=!0,n=f,f=s,e(),f=n,r=!1)};return s.id=t,s(),s}function E(e,t){if(null==t)return t=document.createTextNode(""),e.replaceWith(t),t;if(t instanceof Array){let e=document.createDocumentFragment();for(let n of t)n instanceof Node||(n=document.createTextNode(n)),e.appendChild(n);t=e}else t instanceof Node||(t=document.createTextNode(t));return e.replaceWith(t),t}const R=o,_=a,w=u,C=h;export{R as Router,_ as Api,w as Utils,C as db,y as signal,P as effect,E as replaceNode};
//# sourceMappingURL=riza.js.map
